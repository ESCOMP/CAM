!! This CARMA model is for sulfate aerosols and is based upon work done by Mike Mills
!! and Jason English, which is described in English et al. 2011.
!!
!! These aerosols are not currently radiatively active and do not replace the sulfate
!! aerosols in CAM; however, this is something that could be done in the future.
!!
!! This module defines several constants needed by CARMA, extends a couple of CARMA
!! interface methods:
!!
!!   - CARMA_DefineModel()
!!   - CARMA_EmitParticle()
!!
!! @version Dec-2010
!! @author  Tianyi Fan, Chuck Bardeen
module carma_model_mod

  use carma_precision_mod
  use carma_enums_mod
  use carma_constants_mod
  use carma_types_mod
  use carmaelement_mod
  use carmagas_mod
  use carmagroup_mod
  use carmasolute_mod
  use carmastate_mod
  use carma_mod
  use carma_flags_mod

  use spmd_utils,     only: masterproc
  use radconstants,   only: nswbands, nlwbands
  use cam_abortutils, only: endrun
  use physics_types,  only: physics_state, physics_ptend
  use ppgrid,         only: pcols, pver
  use physics_buffer, only: physics_buffer_desc

  implicit none

  private

  ! Declare the public methods.
  public CARMAMODEL_CalculateCloudborneDiagnostics
  public CARMAMODEL_CreateOpticsFile
  public CARMAMODEL_DefineModel
  public CARMAMODEL_Detrain
  public CARMAMODEL_DiagnoseBins
  public CARMAMODEL_DiagnoseBulk
  public CARMAMODEL_EmitParticle
  public CARMAMODEL_InitializeModel
  public CARMAMODEL_InitializeParticle
  public CARMAMODEL_OutputBudgetDiagnostics
  public CARMAMODEL_OutputCloudborneDiagnostics
  public CARMAMODEL_OutputDiagnostics
  public CARMAMODEL_WetDeposition

  ! Declare public constants
  integer, public, parameter      :: NGROUP   = 1               !! Number of particle groups
  integer, public, parameter      :: NELEM    = 1               !! Number of particle elements
  integer, public, parameter      :: NBIN     = 30              !! Number of particle bins
  integer, public, parameter      :: NSOLUTE  = 0               !! Number of particle solutes
  integer, public, parameter      :: NGAS     = 2               !! Number of gases

  ! These need to be defined, but are only used when the particles are radiatively active.
  integer, public, parameter      :: NMIE_RH  = 8               !! Number of relative humidities for mie calculations
  real(kind=f), public            :: mie_rh(NMIE_RH)

  integer, public, parameter      :: NMIE_WTP = 0              !! Number of weight percents for mie calculations
  real(kind=f), public            :: mie_wtp(NMIE_WTP)
  integer, public, parameter      :: NREFIDX = 1               !! Number of refractive indices per element

  ! Defines whether the groups should undergo deep convection in phase 1 or phase 2.
  ! Water vapor and cloud particles are convected in phase 1, while all other constituents
  ! are done in phase 2.
  logical, public                 :: is_convtran1(NGROUP) = .false.  !! Should the group be transported in the first phase?

  ! Define any particle compositions that are used. Each composition type
  ! should have a unique number.
  integer, public, parameter      :: I_H2SO4   = 1               !! sulfate aerosol composition
  integer, public, parameter      :: I_WATER   = 2               !! water

  ! Define group, element, solute and gas indexes.
  integer, public, parameter      :: I_GRP_SULFATE  = 1              !! sulfate aerosol

  integer, public, parameter      :: I_ELEM_SULFATE = 1              !! sulfate aerosol

  integer, public, parameter      :: I_GAS_H2O      = 1              !! water vapor
  integer, public, parameter      :: I_GAS_H2SO4    = 2              !! sulphuric acid

  real(kind=f), public, parameter :: WTMOL_H2SO4    = 98.078479_f    !! molecular weight of sulphuric acid

  ! Physics buffer index for sulfate surface area density
  integer                         :: ipbuf4sad, ipbuf4reff, ipbuf4so4mmr

contains


  !! Defines all the CARMA components (groups, elements, solutes and gases) and process
  !! (coagulation, growth, nucleation) that will be part of the microphysical model.
  !!
  !!  @version May-2009
  !!  @author  Chuck Bardeen
  subroutine CARMAMODEL_DefineModel(carma, rc)
    use physics_buffer, only: pbuf_add_field, dtype_r8

    type(carma_type), intent(inout)    :: carma     !! the carma object
    integer, intent(out)               :: rc        !! return code, negative indicates failure

    ! Local variables
    real(kind=f), parameter            :: RHO_SULFATE = 1.923_f    ! dry density of sulfate particles (g/cm3)
!  Set radius of smallest bin such that mass is that of 2 molecules of H2SO4:
    real(kind=f), parameter            :: rmin        = 3.43230298e-8_f  ! minimum radius (cm)
    real(kind=f), parameter            :: vmrat       = 2.4_f    ! volume ratio
    integer                            :: LUNOPRT
    logical                            :: do_print

    ! Default return code.
    rc = RC_OK

    call CARMA_Get(carma, rc, do_print=do_print, LUNOPRT=LUNOPRT)
    if (rc < RC_OK) call endrun('CARMA_DefineModel::CARMA_Get failed.')

    ! Report model specific configuration parameters.
    if (masterproc) then
      if (do_print) then
        write(LUNOPRT,*) ''
        write(LUNOPRT,*) 'CARMA ', trim(carma_model), ' specific settings :'
        write(LUNOPRT,*) '  carma_hetchem_feedback = ', carma_hetchem_feedback
      end if
    end if

    ! Define the Groups
    !
    ! NOTE: For CAM, the optional do_wetdep and do_drydep flags should be
    ! defined. If wetdep is defined, then the optional solubility factor
    ! should also be defined.
    ! solfac was formerly set to 0.3, changed to 1.0 because it seems physical.
    ! This change needs to be validated -MJM 12/1/2011
    call CARMAGROUP_Create(carma, I_GRP_SULFATE, "sulfate", rmin, vmrat, I_SPHERE, 1._f, .false., &
                           rc, irhswell=I_WTPCT_H2SO4, do_wetdep=.true., do_drydep=.true., solfac=1.0_f, &
                           scavcoef=0.1_f, is_sulfate=.true., shortname="PURSUL")
    if (rc < 0) call endrun('CARMA_DefineModel::CARMA_AddGroup failed.')


    ! Define the Elements
    !
    ! NOTE: For CAM, the optional shortname needs to be provided for the group. These names
    ! should be 6 characters or less and without spaces.
    call CARMAELEMENT_Create(carma, I_ELEM_SULFATE, I_GRP_SULFATE, "Sulfate", RHO_SULFATE, &
         I_VOLATILE, I_H2SO4, rc, shortname="PURSUL")
    if (rc < 0) call endrun('CARMA_DefineModel::CARMA_AddElement failed.')

    ! Define the Solutes


    ! Define the Gases
    call CARMAGAS_Create(carma, I_GAS_H2O, "Water Vapor", WTMOL_H2O, I_VAPRTN_H2O_MURPHY2005, I_GCOMP_H2O, &
                         rc, shortname = "Q", ds_threshold=-0.2_f)
    if (rc < RC_OK) call endrun('CARMA_DefineModel::CARMAGAS_Create failed.')

    call CARMAGAS_Create(carma, I_GAS_H2SO4, "Sulfuric Acid", WTMOL_H2SO4, I_VAPRTN_H2SO4_AYERS1980, &
                         I_GCOMP_H2SO4, rc, shortname = "H2SO4", ds_threshold=-0.2_f)
    if (rc < RC_OK) call endrun('CARMA_DefineModel::CARMAGAS_Create failed.')

    ! Define the Processes

    ! Set H2SO4 to be the condensing gas, water vapor is assumed to be in equilibrium
    ! and will be used to define the wet particle radius.
    call CARMA_AddGrowth(carma, I_ELEM_SULFATE, I_GAS_H2SO4, rc)
    if (rc < RC_OK) call endrun('CARMA_DefineModel::CARMA_AddGrowth failed.')

    call CARMA_AddNucleation(carma, I_ELEM_SULFATE, I_ELEM_SULFATE, I_HOMNUC, 0._f, rc, igas=I_GAS_H2SO4)
    if (rc < RC_OK) call endrun('CARMA_DefineModel::CARMA_AddNucleation failed.')

    call CARMA_AddCoagulation(carma, I_GRP_SULFATE, I_GRP_SULFATE, I_GRP_SULFATE, I_COLLEC_FUCHS, rc)
    if (rc < RC_OK) call endrun('CARMA_DefineModel::CARMA_AddCoagulation failed.')

    call pbuf_add_field('SADSULF', 'global', dtype_r8, (/pcols, pver/), ipbuf4sad)

    if (carma_rad_feedback) then
       call pbuf_add_field('VOLC_RAD_GEOM', 'global', dtype_r8, (/pcols, pver/), ipbuf4reff)
       call pbuf_add_field('VOLC_MMR', 'global', dtype_r8, (/pcols, pver/), ipbuf4so4mmr)
    endif

  end subroutine CARMAMODEL_DefineModel


  !! Defines all the CARMA components (groups, elements, solutes and gases) and process
  !! (coagulation, growth, nucleation) that will be part of the microphysical model.
  !!
  !!  @version May-2009
  !!  @author  Chuck Bardeen
  !!
  !!  @see CARMASTATE_SetDetrain
  subroutine CARMAMODEL_Detrain(carma, cstate, cam_in, dlf, state, icol, dt, rc, rliq, prec_str, snow_str, &
     tnd_qsnow, tnd_nsnow)
    use camsrfexch,         only: cam_in_t
    use physconst,          only: latice, latvap, cpair

    implicit none

    type(carma_type), intent(in)         :: carma            !! the carma object
    type(carmastate_type), intent(inout) :: cstate           !! the carma state object
    type(cam_in_t),  intent(in)          :: cam_in           !! surface input
    real(r8), intent(in)                 :: dlf(pcols, pver) !! Detraining cld H20 from convection (kg/kg/s)
    type(physics_state), intent(in)      :: state            !! physics state variables
    integer, intent(in)                  :: icol             !! column index
    real(r8), intent(in)                 :: dt               !! time step (s)
    integer, intent(out)                 :: rc               !! return code, negative indicates failure
    real(r8), intent(inout), optional    :: rliq(pcols)      !! vertical integral of liquid not yet in q(ixcldliq)
    real(r8), intent(inout), optional    :: prec_str(pcols)  !! [Total] sfc flux of precip from stratiform (m/s)
    real(r8), intent(inout), optional    :: snow_str(pcols)  !! [Total] sfc flux of snow from stratiform (m/s)
    real(r8), intent(out), optional      :: tnd_qsnow(pcols,pver) !! snow mass tendency (kg/kg/s)
    real(r8), intent(out), optional      :: tnd_nsnow(pcols,pver) !! snow number tendency (#/kg/s)

    ! Default return code.
    rc = RC_OK

    return
  end subroutine CARMAMODEL_Detrain


  !! For diagnostic groups, sets up up the CARMA bins based upon the CAM state.
  !!
  !!  @version July-2009
  !!  @author  Chuck Bardeen
  subroutine CARMAMODEL_DiagnoseBins(carma, cstate, state, pbuf, icol, dt, rc, rliq, prec_str, snow_str)
    use time_manager,     only: is_first_step

    implicit none

    type(carma_type), intent(in)          :: carma        !! the carma object
    type(carmastate_type), intent(inout)  :: cstate       !! the carma state object
    type(physics_state), intent(in)       :: state        !! physics state variables
    type(physics_buffer_desc), pointer    :: pbuf(:)      !! physics buffer
    integer, intent(in)                   :: icol         !! column index
    real(r8), intent(in)                  :: dt           !! time step
    integer, intent(out)                  :: rc           !! return code, negative indicates failure
    real(r8), intent(in), optional        :: rliq(pcols)      !! vertical integral of liquid not yet in q(ixcldliq)
    real(r8), intent(inout), optional     :: prec_str(pcols)  !! [Total] sfc flux of precip from stratiform (m/s)
    real(r8), intent(inout), optional     :: snow_str(pcols)  !! [Total] sfc flux of snow from stratiform (m/s)

    real(r8)                             :: mmr(pver) !! elements mass mixing ratio
    integer                              :: ibin      !! bin index

    ! Default return code.
    rc = RC_OK

    ! By default, do nothing. If diagnosed groups exist, this needs to be replaced by
    ! code to determine the mass in each bin from the CAM state.

    return
  end subroutine CARMAMODEL_DiagnoseBins


  !! For diagnostic groups, determines the tendencies on the CAM state from the CARMA bins.
  !!
  !!  @version July-2009
  !!  @author  Chuck Bardeen
  subroutine CARMAMODEL_DiagnoseBulk(carma, cstate, cam_out, state, pbuf, ptend, icol, dt, rc, rliq, prec_str, snow_str, &
    prec_sed, snow_sed, tnd_qsnow, tnd_nsnow, re_ice)
    use camsrfexch,    only: cam_out_t
    use physics_buffer, only: pbuf_get_field

    implicit none

    type(carma_type), intent(in)         :: carma     !! the carma object
    type(carmastate_type), intent(inout) :: cstate    !! the carma state object
    type(cam_out_t),      intent(inout)  :: cam_out   !! cam output to surface models
    type(physics_state), intent(in)      :: state     !! physics state variables
    type(physics_buffer_desc), pointer   :: pbuf(:)   !! physics buffer
    type(physics_ptend), intent(inout)   :: ptend     !! constituent tendencies
    integer, intent(in)                  :: icol      !! column index
    real(r8), intent(in)                 :: dt        !! time step
    integer, intent(out)                 :: rc        !! return code, negative indicates failure
    real(r8), intent(inout), optional    :: rliq(pcols)      !! vertical integral of liquid not yet in q(ixcldliq)
    real(r8), intent(inout), optional    :: prec_str(pcols)  !! [Total] sfc flux of precip from stratiform (m/s)
    real(r8), intent(inout), optional    :: snow_str(pcols)  !! [Total] sfc flux of snow from stratiform (m/s)
    real(r8), intent(inout), optional    :: prec_sed(pcols)       !! total precip from cloud sedimentation (m/s)
    real(r8), intent(inout), optional    :: snow_sed(pcols)       !! snow from cloud ice sedimentation (m/s)
    real(r8), intent(inout), optional    :: tnd_qsnow(pcols,pver) !! snow mass tendency (kg/kg/s)
    real(r8), intent(inout), optional    :: tnd_nsnow(pcols,pver) !! snow number tendency (#/kg/s)
    real(r8), intent(out), optional      :: re_ice(pcols,pver)    !! ice effective radius (m)

    ! Local variables
    real(r8)                             :: numberDensity(cstate%f_NZ)
    real(r8)                             :: ad(cstate%f_NZ)       ! stratospheric aerosol wet surface area density (cm2/cm3)
    real(r8)                             :: reff(cstate%f_NZ)     ! stratospheric wet effective radius (m)
    real(r8)                             :: md(cstate%f_NZ)       ! bin integrated stratospheric mass mixing ratio (kg/kg)
    real(r8)                             :: mmr(cstate%f_NZ)      ! stratospheric mass mixing ratio per bin (kg/kg)
    real(r8)                             :: r_wet(cstate%f_NZ)    ! Sulfate aerosol bin wet radius (cm)
    real(r8), pointer, dimension(:,:)    :: sadsulf_ptr           ! Sulfate surface area density pointer
    real(r8), pointer, dimension(:,:)    :: reffsulf_ptr          ! Sulfate effective radius pointer
    real(r8), pointer, dimension(:,:)    :: mmrsulf_ptr           ! Sulfate mass mixing ratio pointer
    integer                              :: ibin, igroup

    ! Default return code.
    rc = RC_OK

    call CARMAELEMENT_Get(carma, I_ELEM_SULFATE, rc, igroup=igroup)
    if (rc < 0) call endrun('CARMA_DiagnoseBulk::CARMAELEMENT_Get failed.')

    ad(:)  = 0.0_r8     ! stratospheric wet aerosol surface area density (cm2/cm3)
    md(:)  = 0.0_r8     ! bin integrated stratospheric mass mixing ratio (kg/kg)
    reff(:)  = 0.0_r8   ! stratospheric effective radius (m)

    do ibin = 1, NBIN
      call CARMASTATE_GetBin(cstate, I_ELEM_SULFATE, ibin, mmr(:), rc, &
                             numberDensity=numberDensity, r_wet=r_wet)
      if (rc < 0) call endrun('CARMA_DiagnoseBulk::CARMASTATE_GetBin failed.')

      ! Calculate the total densities.
      !
      ! NOTE: Calculate AD in cm2/cm3.
      if (numberDensity(1) /= CAM_FILL) then
        ad(:)  = ad(:)  + numberDensity(:) * (r_wet(:)**2)
        reff(:) = reff(:) + numberDensity(:) * (r_wet(:)**3)
        md(:)  = md(:)  + mmr(:)  ! bin integrated stratospheric mass mixing ratio (kg/kg)
      end if
    end do

    reff(:) = reff(:) / ad(:) ! wet effective radius in cm
    reff(:) = reff(:) / 100.0_r8 ! cm -> m
    ad(:)  = ad(:) * 4.0_r8 * PI ! surface area density in cm2/cm3

    call pbuf_get_field(pbuf, ipbuf4sad, sadsulf_ptr)
    sadsulf_ptr(icol, :cstate%f_NZ) = ad(:cstate%f_NZ)    ! stratospheric aerosol wet surface area density (cm2/cm3)

    if (carma_rad_feedback) then
      call pbuf_get_field(pbuf, ipbuf4reff, reffsulf_ptr)
      reffsulf_ptr(icol, :cstate%f_NZ) = reff(:cstate%f_NZ) ! stratospheric wet effective radius (m)

      call pbuf_get_field(pbuf, ipbuf4so4mmr, mmrsulf_ptr)
      mmrsulf_ptr(icol, :cstate%f_NZ) = md(:cstate%f_NZ)    ! bin integrated stratospheric mass mixing ratio (kg/kg)
    end if


  end subroutine CARMAMODEL_DiagnoseBulk


  !! Calculates the emissions for CARMA aerosol particles. By default, there is no
  !! emission, but this routine can be overridden for models that wish to have
  !! an aerosol emission.
  !!
  !! @author  Tianyi Fan, Chuck Bardeen
  !! @version Dec-2010
  subroutine CARMAMODEL_EmitParticle(carma, ielem, ibin, icnst, dt, state, cam_in, tendency, surfaceFlux, pbuf, rc)
    use shr_kind_mod,  only: r8 => shr_kind_r8
    use ppgrid,        only: pcols, pver
    use physics_types, only: physics_state
    use time_manager,  only: get_curr_date, get_perp_date, get_curr_calday, &
                             is_perpetual
    use camsrfexch,       only: cam_in_t

    implicit none

    type(carma_type), intent(in)       :: carma                 !! the carma object
    integer, intent(in)                :: ielem                 !! element index
    integer, intent(in)                :: ibin                  !! bin index
    integer, intent(in)                :: icnst                 !! consituent index
    real(r8), intent(in)               :: dt                    !! time step (s)
    type(physics_state), intent(in)    :: state                 !! physics state
    type(cam_in_t), intent(in)         :: cam_in                !! surface inputs
    real(r8), intent(out)              :: tendency(pcols, pver) !! constituent tendency (kg/kg/s)
    real(r8), intent(out)              :: surfaceFlux(pcols)    !! constituent surface flux (kg/m^2/s)
    type(physics_buffer_desc), pointer :: pbuf(:)               !! physics buffer
    integer,  intent(out)              :: rc                    !! return code, negative indicates failure

    ! Default return code.
    rc = RC_OK

    ! Add any surface flux here.
    surfaceFlux = 0._r8

    ! For emissions into the atmosphere, put the emission here.
    tendency = 0._r8

    return
  end subroutine CARMAMODEL_EmitParticle


  !! Allows the model to perform its own initialization in addition to what is done
  !! by default in CARMA_init.
  !!
  !! @author  Chuck Bardeen
  !! @version May-2009
  subroutine CARMAMODEL_InitializeModel(carma, lq_carma, pbuf2d, rc)
    use constituents, only : pcnst
    implicit none

    type(carma_type), intent(in)       :: carma                 !! the carma object
    logical, intent(inout)             :: lq_carma(pcnst)       !! flags to indicate whether the constituent
                                                                !! could have a CARMA tendency
    type(physics_buffer_desc), pointer :: pbuf2d(:,:)
    integer, intent(out)               :: rc                    !! return code, negative indicates failure

    ! Default return code.
    rc = RC_OK

    return
  end subroutine CARMAMODEL_InitializeModel


  !! Sets the initial condition for CARMA aerosol particles. By default, there are no
  !! particles, but this routine can be overridden for models that wish to have an
  !! initial value.
  !!
  !! NOTE: If CARMA constituents appear in the initial condition file, then those
  !! values will override anything set here.
  !!
  !! @author  Chuck Bardeen
  !! @version May-2009
  subroutine CARMAMODEL_InitializeParticle(carma, ielem, ibin, latvals, lonvals, mask, q, rc)
    use shr_kind_mod,   only: r8 => shr_kind_r8

    implicit none

    type(carma_type), intent(in)  :: carma      !! the carma object
    integer,          intent(in)  :: ielem      !! element index
    integer,          intent(in)  :: ibin       !! bin index
    real(r8),         intent(in)  :: latvals(:) !! lat in degrees (ncol)
    real(r8),         intent(in)  :: lonvals(:) !! lon in degrees (ncol)
    logical,          intent(in)  :: mask(:)    !! Only initialize where .true.
    real(r8),         intent(out) :: q(:,:)     !! mass mixing ratio (gcol, lev)
    integer,          intent(out) :: rc         !! return code, negative indicates failure

    ! Default return code.
    rc = RC_OK

    ! Add initial condition here.
    !
    ! NOTE: Initialized to 0. by the caller, so nothing needs to be done.

    return
  end subroutine CARMAMODEL_InitializeParticle


  !! This routine is an extension of CARMA_CreateOpticsFile() that allows for
  !! model specific tables to be created in addition to the model independent
  !! methods that are in carma_intr.F90.
  !!
  !! The opticsType that is specified for the group determines how the optical
  !! properties will be generated for that group. Each group can use a different
  !! optics method if needed. Refractive indices need for these calculation are
  !! are specified in the group's elements rather than at the group level. This
  !! allows various mixing approaches to be used to determine the refractive index
  !! for the particle as a whole. If the refractive index for water is needed,
  !! it is specific the the CARMAGAS object for H2O.
  subroutine CARMAMODEL_CreateOpticsFile(carma, igroup, opticsType, rc)

    implicit none

    type(carma_type), intent(inout)     :: carma         !! the carma object
    integer, intent(in)                 :: igroup        !! group identifier
    integer, intent(in)                 :: opticsType    !! optics type (see I_OPTICS_... in carma_enums.F90)
    integer, intent(out)                :: rc            !! return code, negative indicates failure

    ! Local variables
    logical                             :: do_mie
    integer                             :: cnsttype               ! constituent type

    ! Assume success.
    rc = 0

    ! What type of calculation is needed for this group?
    !
    ! NOTE: Some of these calculations generate optical properties as single mass
    ! coefficients, while others are lookup tables designed around multiple
    ! dimensions.
    select case (opticsType)

      case default
        call endrun('carma_CreateOpticsFile:: Unknown optics type.')
    end select

    return
  end subroutine CARMAMODEL_CreateOpticsFile


  !!  Called after wet deposition has been performed. Allows the specific model to add
  !!  wet deposition of CARMA aerosols to the aerosols being communicated to the surface.
  !!
  !!  @version July-2011
  !!  @author  Chuck Bardeen
  subroutine CARMAMODEL_WetDeposition(carma, ielem, ibin, sflx, cam_out, state, rc)
    use camsrfexch,       only: cam_out_t

    implicit none

    type(carma_type), intent(in)         :: carma       !! the carma object
    integer, intent(in)                  :: ielem       !! element index
    integer, intent(in)                  :: ibin        !! bin index
    real(r8), intent(in)                 :: sflx(pcols) !! surface flux (kg/m2/s)
    type(cam_out_t), intent(inout)       :: cam_out     !! cam output to surface models
    type(physics_state), intent(in)      :: state       !! physics state variables
    integer, intent(out)                 :: rc          !! return code, negative indicates failure

    integer    :: icol

    ! Default return code.
    rc = RC_OK

    return
  end subroutine CARMAMODEL_WetDeposition


  !! Called at the end of the timestep after all the columns have been processed to
  !! to allow additional diagnostics that have been stored in pbuf to be output.
  !!
  !! Stub version
  subroutine CARMAMODEL_CalculateCloudborneDiagnostics(carma, state, pbuf, aerclddiag, rc)

    type(carma_type), intent(in)         :: carma        !! the carma object
    type(physics_state), intent(in)      :: state        !! Physics state variables - before pname
    type(physics_buffer_desc), pointer, intent(in)   :: pbuf(:)      !! physics buffer
    real(r8), intent(out)                :: aerclddiag(pcols,MAXCLDAERDIAG) !! the total cloudborne aerosols, supports up to MAXCLDAERDIAG different values
    integer, intent(out)                 :: rc           !! return code, negative indicates failure

    ! Default return code.
    rc = RC_OK

    return
  end subroutine CARMAMODEL_CalculateCloudborneDiagnostics

  !! Called at the end of the timestep after all the columns have been processed to
  !! to allow additional diagnostics that have been stored in pbuf to be output.
  !!
  !! Stub version
  subroutine CARMAMODEL_OutputBudgetDiagnostics(carma, icnst4elem, icnst4gas, state, ptend, old_cflux, cflux, dt, pname, rc)
    use cam_history,  only: outfld
    use constituents, only: pcnst, cnst_get_ind

    type(carma_type), intent(in)         :: carma        !! the carma object
    integer, intent(in)                  :: icnst4elem(NELEM, NBIN) !! constituent index for a carma element
    integer, intent(in)                  :: icnst4gas(NGAS)         !! constituent index for a carma gas
    type(physics_state), intent(in)      :: state        !! Physics state variables - before pname
    type(physics_ptend), intent(in)      :: ptend        !! indivdual parameterization tendencies
    real(r8)                             :: old_cflux(pcols,pcnst)  !! cam_in%clfux from before the timestep_tend
    real(r8)                             :: cflux(pcols,pcnst)  !! cam_in%clfux from after the timestep_tend
    real(r8), intent(in)                 :: dt           !! timestep (s)
    character(*), intent(in)             :: pname        !! short name of the physics package
    integer, intent(out)                 :: rc           !! return code, negative indicates failure

    ! Default return code.
    rc = RC_OK

    return
  end subroutine CARMAMODEL_OutputBudgetDiagnostics

  !! Called at the end of the timestep after all the columns have been processed to
  !! to allow additional diagnostics that have been stored in pbuf to be output.
  !!
  !! Stub version
  subroutine CARMAMODEL_OutputCloudborneDiagnostics(carma, state, pbuf, dt, pname, oldaerclddiag, rc)
    use cam_history, only: outfld

    type(carma_type), intent(in)         :: carma        !! the carma object
    type(physics_state), intent(in)      :: state        !! Physics state variables - before CARMA
    type(physics_buffer_desc), pointer, intent(in)   :: pbuf(:)      !! physics buffer
    real(r8), intent(in)                 :: dt           !! timestep (s)
    character(*), intent(in)             :: pname        !! short name of the physics package
    real(r8), intent(in )                :: oldaerclddiag(pcols,MAXCLDAERDIAG) !! the before timestep cloudborne aerosol diags
    integer, intent(out)                 :: rc           !! return code, negative indicates failure

    ! Default return code.
    rc = RC_OK

    return
  end subroutine CARMAMODEL_OutputCloudborneDiagnostics

  !! Called at the end of the timestep after all the columns have been processed to
  !! to allow additional diagnostics that have been stored in pbuf to be output.
  !!
  !! Stub version
  subroutine CARMAMODEL_OutputDiagnostics(carma, icnst4elem, state, ptend, pbuf, cam_in, rc)
    use cam_history,   only: outfld
    use constituents,  only: cnst_get_ind
    use camsrfexch,    only: cam_in_t

    type(carma_type), intent(in)         :: carma        !! the carma object
    integer, intent(in)                  :: icnst4elem(NELEM, NBIN) !! constituent index for a carma element
    type(physics_state), intent(in)      :: state        !! Physics state variables - before CARMA
    type(physics_ptend), intent(in)      :: ptend        !! indivdual parameterization tendencies
    type(physics_buffer_desc), pointer, intent(in)   :: pbuf(:)  !! physics buffer
    type(cam_in_t), intent(in)           :: cam_in       !! surface inputs
    integer, intent(out)                 :: rc           !! return code, negative indicates failure

    ! Default return code.
    rc = RC_OK

    return
  end subroutine CARMAMODEL_OutputDiagnostics

end module
